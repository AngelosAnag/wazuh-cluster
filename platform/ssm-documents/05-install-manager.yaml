###############################################################################
# SSM Document: Install Wazuh Manager
# Run this on node-1 (master) and node-2 (worker)
###############################################################################

schemaVersion: "2.2"
description: "Install and configure Wazuh Manager"
parameters:
  NodeName:
    type: String
    description: "Node name (node-1 or node-2)"
    allowedValues:
      - node-1
      - node-2
  NodeType:
    type: String
    description: "Manager type (master or worker)"
    allowedValues:
      - master
      - worker
  MasterIP:
    type: String
    description: "Private IP of master node (node-1)"
  Node1IP:
    type: String
    description: "Private IP of node-1 (indexer)"
  Node2IP:
    type: String
    description: "Private IP of node-2 (indexer)"
  Node3IP:
    type: String
    description: "Private IP of node-3 (indexer)"
  ClusterKey:
    type: String
    description: "32-character cluster key (same for all managers)"
    default: "c98b62a9b6169ac5f67dae55ae4a9088"
mainSteps:
  - action: aws:runShellScript
    name: InstallWazuhManager
    inputs:
      timeoutSeconds: "900"
      runCommand:
        - |
          #!/bin/bash
          set -e
          
          NODE_NAME="{{ NodeName }}"
          NODE_TYPE="{{ NodeType }}"
          MASTER_IP="{{ MasterIP }}"
          NODE1_IP="{{ Node1IP }}"
          NODE2_IP="{{ Node2IP }}"
          NODE3_IP="{{ Node3IP }}"
          CLUSTER_KEY="{{ ClusterKey }}"
          
          echo "=== Installing Wazuh Manager ($NODE_TYPE) on $NODE_NAME ==="
          
          # Install Wazuh Manager
          apt-get update
          apt-get install -y wazuh-manager
          
          # Configure cluster in ossec.conf
          # First, backup original
          cp /var/ossec/etc/ossec.conf /var/ossec/etc/ossec.conf.bak
          
          # Update cluster configuration
          sed -i 's/<cluster>/<cluster>\n    <name>wazuh-cluster<\/name>/' /var/ossec/etc/ossec.conf
          
          # Use xmlstarlet or sed to update cluster config
          cat > /tmp/cluster-config.xml << EOF
            <cluster>
              <name>wazuh-cluster</name>
              <node_name>$NODE_NAME</node_name>
              <node_type>$NODE_TYPE</node_type>
              <key>$CLUSTER_KEY</key>
              <port>1516</port>
              <bind_addr>0.0.0.0</bind_addr>
              <nodes>
                <node>$MASTER_IP</node>
              </nodes>
              <hidden>no</hidden>
              <disabled>no</disabled>
            </cluster>
          EOF
          
          # Replace cluster section in ossec.conf
          python3 << 'PYEOF'
          import re
          
          with open('/var/ossec/etc/ossec.conf', 'r') as f:
              content = f.read()
          
          with open('/tmp/cluster-config.xml', 'r') as f:
              new_cluster = f.read()
          
          # Replace cluster section
          pattern = r'<cluster>.*?</cluster>'
          content = re.sub(pattern, new_cluster.strip(), content, flags=re.DOTALL)
          
          with open('/var/ossec/etc/ossec.conf', 'w') as f:
              f.write(content)
          
          print("Cluster configuration updated")
          PYEOF
          
          # Enable and start Wazuh Manager
          systemctl daemon-reload
          systemctl enable wazuh-manager
          systemctl start wazuh-manager
          
          # Wait for manager to start
          sleep 15
          
          echo "=== Installing Filebeat ==="
          
          # Install Filebeat
          apt-get install -y filebeat
          
          # Download Wazuh Filebeat module
          curl -s https://packages.wazuh.com/4.x/filebeat/wazuh-filebeat-0.4.tar.gz | \
            tar -xvz -C /usr/share/filebeat/module
          
          # Download Filebeat config
          curl -so /etc/filebeat/filebeat.yml \
            https://packages.wazuh.com/4.14/tpl/wazuh/filebeat/filebeat.yml
          
          # Configure Filebeat to point to all indexers
          cat > /etc/filebeat/filebeat.yml << EOF
          # Wazuh - Filebeat configuration file
          output.elasticsearch:
            hosts:
              - "$NODE1_IP:9200"
              - "$NODE2_IP:9200"
              - "$NODE3_IP:9200"
            protocol: https
            username: admin
            password: admin
            ssl.certificate_authorities:
              - /etc/filebeat/certs/root-ca.pem
            ssl.certificate: "/etc/filebeat/certs/filebeat.pem"
            ssl.key: "/etc/filebeat/certs/filebeat-key.pem"
          
          setup.template.json.enabled: true
          setup.template.json.path: '/etc/filebeat/wazuh-template.json'
          setup.template.json.name: 'wazuh'
          setup.template.overwrite: true
          setup.ilm.enabled: false
          
          filebeat.modules:
            - module: wazuh
              alerts:
                enabled: true
              archives:
                enabled: false
          
          logging.level: info
          logging.to_files: true
          logging.files:
            path: /var/log/filebeat
            name: filebeat
            keepfiles: 7
            permissions: 0644
          EOF
          
          # Download Wazuh template
          curl -so /etc/filebeat/wazuh-template.json \
            https://raw.githubusercontent.com/wazuh/wazuh/v4.14.0/extensions/elasticsearch/7.x/wazuh-template.json
          
          # Set permissions on certs
          chmod 400 /etc/filebeat/certs/*
          
          # Enable and start Filebeat
          systemctl daemon-reload
          systemctl enable filebeat
          systemctl start filebeat
          
          # Wait and verify
          sleep 10
          
          echo "=== Wazuh Manager Installation Complete ==="
          echo ""
          echo "Manager status:"
          systemctl status wazuh-manager --no-pager || true
          echo ""
          echo "Filebeat status:"
          systemctl status filebeat --no-pager || true
          echo ""
          echo "Cluster status:"
          /var/ossec/bin/cluster_control -l || true
