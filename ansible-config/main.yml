---
# Certificate generation role
# Runs locally to generate all Wazuh certificates

- name: Create certificate directory
  file:
    path: "{{ playbook_dir }}/certs"
    state: directory
    mode: '0755'

- name: Download Wazuh certificate tool
  get_url:
    url: "https://packages.wazuh.com/{{ wazuh_version }}/wazuh-certs-tool.sh"
    dest: "{{ playbook_dir }}/certs/wazuh-certs-tool.sh"
    mode: '0755'

- name: Create certificate configuration
  template:
    src: config.yml.j2
    dest: "{{ playbook_dir }}/certs/config.yml"
    mode: '0644'

- name: Generate certificates
  command:
    cmd: ./wazuh-certs-tool.sh -A
    chdir: "{{ playbook_dir }}/certs"
    creates: "{{ playbook_dir }}/certs/wazuh-certificates.tar"

- name: Extract certificates
  unarchive:
    src: "{{ playbook_dir }}/certs/wazuh-certificates.tar"
    dest: "{{ playbook_dir }}/certs/"
    remote_src: false
    creates: "{{ playbook_dir }}/certs/wazuh-certificates"

- name: Generate cluster key
  shell: |
    if [ ! -f "{{ playbook_dir }}/cluster-key.txt" ]; then
      openssl rand -hex 16 > "{{ playbook_dir }}/cluster-key.txt"
    fi
    cat "{{ playbook_dir }}/cluster-key.txt"
  register: cluster_key_result
  changed_when: false

- name: Set cluster key fact
  set_fact:
    cluster_key: "{{ cluster_key_result.stdout }}"
    cacheable: true

- name: Display cluster key
  debug:
    msg: "Cluster Key: {{ cluster_key }} (saved to {{ playbook_dir }}/cluster-key.txt)"
