---
# Wazuh Manager installation and configuration

- name: Install Wazuh Manager
  dnf:
    name: wazuh-manager
    state: present

- name: Create certificates directory
  file:
    path: "{{ manager_cert_dir }}"
    state: directory
    owner: wazuh
    group: wazuh
    mode: '0750'

- name: Copy manager certificate
  copy:
    src: "{{ playbook_dir }}/certs/wazuh-certificates/{{ node_name }}.pem"
    dest: "{{ manager_cert_dir }}/wazuh-manager.pem"
    owner: wazuh
    group: wazuh
    mode: '0440'

- name: Copy manager key
  copy:
    src: "{{ playbook_dir }}/certs/wazuh-certificates/{{ node_name }}-key.pem"
    dest: "{{ manager_cert_dir }}/wazuh-manager-key.pem"
    owner: wazuh
    group: wazuh
    mode: '0400'

- name: Copy root CA certificate
  copy:
    src: "{{ playbook_dir }}/certs/wazuh-certificates/root-ca.pem"
    dest: "{{ manager_cert_dir }}/root-ca.pem"
    owner: wazuh
    group: wazuh
    mode: '0440'

- name: Read cluster key
  set_fact:
    cluster_key: "{{ lookup('file', playbook_dir + '/cluster-key.txt') }}"

- name: Configure Wazuh Manager
  template:
    src: ossec.conf.j2
    dest: /var/ossec/etc/ossec.conf
    owner: root
    group: wazuh
    mode: '0660'
    backup: true
  notify: Restart wazuh-manager

- name: Enable and start Wazuh Manager
  systemd:
    name: wazuh-manager
    enabled: true
    state: started
    daemon_reload: true

- name: Wait for manager to be ready
  wait_for:
    host: "{{ ansible_host }}"
    port: 1515
    delay: 10
    timeout: 120
