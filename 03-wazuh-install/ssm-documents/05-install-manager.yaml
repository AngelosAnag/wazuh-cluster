###############################################################################
# SSM Document: Install Wazuh Manager
# Run this on node-1 (master) and node-2 (worker)
###############################################################################

schemaVersion: "2.2"
description: "Install and configure Wazuh Manager"
parameters:
  NodeName:
    type: String
    description: "Node name (node-1 or node-2)"
    allowedValues:
      - node-1
      - node-2
  NodeType:
    type: String
    description: "Manager type (master or worker)"
    allowedValues:
      - master
      - worker
  MasterIP:
    type: String
    description: "Private IP of master node (node-1)"
  Node1IP:
    type: String
    description: "Private IP of node-1 (indexer)"
  Node2IP:
    type: String
    description: "Private IP of node-2 (indexer)"
  Node3IP:
    type: String
    description: "Private IP of node-3 (indexer)"
  ClusterKey:
    type: String
    description: "32-character cluster key (same for all managers)"
    default: "c98b62a9b6169ac5f67dae55ae4a9088"
mainSteps:
  - action: aws:runShellScript
    name: InstallWazuhManager
    inputs:
      timeoutSeconds: "900"
      runCommand:
        - |
          #!/bin/bash
          set -e
          
          NODE_NAME="{{ NodeName }}"
          NODE_TYPE="{{ NodeType }}"
          MASTER_IP="{{ MasterIP }}"
          NODE1_IP="{{ Node1IP }}"
          NODE2_IP="{{ Node2IP }}"
          NODE3_IP="{{ Node3IP }}"
          CLUSTER_KEY="{{ ClusterKey }}"
          
          echo "=== Installing Wazuh Manager ($NODE_TYPE) on $NODE_NAME ==="
          
          # Ensure Wazuh repo is configured (Amazon Linux 2023)
          if [ ! -f /etc/yum.repos.d/wazuh.repo ]; then
            rpm --import https://packages.wazuh.com/key/GPG-KEY-WAZUH
            cat > /etc/yum.repos.d/wazuh.repo << 'REPO'
          [wazuh]
          gpgcheck=1
          gpgkey=https://packages.wazuh.com/key/GPG-KEY-WAZUH
          enabled=1
          name=EL-$releasever - Wazuh
          baseurl=https://packages.wazuh.com/4.x/yum/
          protect=1
          REPO
          fi
          
          # Install Wazuh Manager
          dnf install -y wazuh-manager
          
          # Configure cluster in ossec.conf
          cp /var/ossec/etc/ossec.conf /var/ossec/etc/ossec.conf.bak
          
          # Create cluster config
          cat > /tmp/cluster-config.xml << EOF
            <cluster>
              <name>wazuh-cluster</name>
              <node_name>$NODE_NAME</node_name>
              <node_type>$NODE_TYPE</node_type>
              <key>$CLUSTER_KEY</key>
              <port>1516</port>
              <bind_addr>0.0.0.0</bind_addr>
              <nodes>
                <node>$MASTER_IP</node>
              </nodes>
              <hidden>no</hidden>
              <disabled>no</disabled>
            </cluster>
          EOF
          
          # Replace cluster section in ossec.conf
          python3 << 'PYEOF'
          import re
          
          with open('/var/ossec/etc/ossec.conf', 'r') as f:
              content = f.read()
          
          with open('/tmp/cluster-config.xml', 'r') as f:
              new_cluster = f.read()
          
          pattern = r'<cluster>.*?</cluster>'
          content = re.sub(pattern, new_cluster.strip(), content, flags=re.DOTALL)
          
          with open('/var/ossec/etc/ossec.conf', 'w') as f:
              f.write(content)
          
          print("Cluster configuration updated")
          PYEOF
          
          # Enable and start Wazuh Manager
          systemctl daemon-reload
          systemctl enable wazuh-manager
          systemctl start wazuh-manager
          
          sleep 15
          
          echo "=== Installing Filebeat ==="
          
          # Install Filebeat (Amazon Linux 2023)
          dnf install -y filebeat
          
          # Download Wazuh Filebeat module
          curl -s https://packages.wazuh.com/4.x/filebeat/wazuh-filebeat-0.4.tar.gz | \
            tar -xvz -C /usr/share/filebeat/module
          
          # Configure Filebeat
          cat > /etc/filebeat/filebeat.yml << EOF
          output.elasticsearch:
            hosts:
              - "$NODE1_IP:9200"
              - "$NODE2_IP:9200"
              - "$NODE3_IP:9200"
            protocol: https
            username: admin
            password: admin
            ssl.certificate_authorities:
              - /etc/filebeat/certs/root-ca.pem
            ssl.certificate: "/etc/filebeat/certs/filebeat.pem"
            ssl.key: "/etc/filebeat/certs/filebeat-key.pem"
          
          setup.template.json.enabled: true
          setup.template.json.path: '/etc/filebeat/wazuh-template.json'
          setup.template.json.name: 'wazuh'
          setup.template.overwrite: true
          setup.ilm.enabled: false
          
          filebeat.modules:
            - module: wazuh
              alerts:
                enabled: true
              archives:
                enabled: false
          
          logging.level: info
          logging.to_files: true
          logging.files:
            path: /var/log/filebeat
            name: filebeat
            keepfiles: 7
            permissions: 0644
          EOF
          
          # Download Wazuh template
          curl -so /etc/filebeat/wazuh-template.json \
            https://raw.githubusercontent.com/wazuh/wazuh/v4.10.0/extensions/elasticsearch/7.x/wazuh-template.json
          
          # Verify filebeat certificates exist
          if [ ! -f /etc/filebeat/certs/filebeat.pem ]; then
            echo "ERROR: Filebeat certificate not found"
            exit 1
          fi

          # Set permissions and ownership
          chown -R root:root /etc/filebeat/certs/
          chmod 500 /etc/filebeat/certs
          chmod 400 /etc/filebeat/certs/*

          echo "Filebeat certificate files:"
          ls -la /etc/filebeat/certs/

          # Enable and start Filebeat
          systemctl daemon-reload
          systemctl enable filebeat
          systemctl start filebeat

          # Wait and verify
          sleep 10

          if ! systemctl is-active --quiet filebeat; then
            echo "WARNING: filebeat may not have started correctly"
            journalctl -u filebeat --no-pager -n 30
          fi
          
          echo "=== Wazuh Manager Installation Complete ==="
          echo ""
          echo "Manager status:"
          systemctl status wazuh-manager --no-pager || true
          echo ""
          echo "Filebeat status:"
          systemctl status filebeat --no-pager || true
          echo ""
          echo "Cluster status:"
          /var/ossec/bin/cluster_control -l || true
